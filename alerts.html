<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanały ZTM - TwojaTrasa.online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="favicons.png" onerror="this.onerror=null; this.href='https://img.icons8.com/ios-filled/50/000000/bus-stop.png';">
    <style>
        /* --- Style CSS (bez zmian w stosunku do poprzedniej odpowiedzi z podziałem) --- */
        :root {
            --bg-primary: #1a1a1a; --bg-secondary: #262626; --bg-tertiary: #333333;
            --text-primary: #e0e0e0; --text-secondary: #9e9e9e; --text-tertiary: #6b6b6b;
            --accent: #99cc00; --accent-hover: #88bb00; --accent-yellow: #ffdd00;
            --text-on-accent: #1a1a1a; --border-color: #404040; --shadow-color: rgba(0, 0, 0, 0.2);
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --font-size-base: 14px; --font-size-small: 12px; --font-size-large: 16px;
            --border-radius: 4px; --transition: all 0.2s ease-in-out;
            --danger-color: #f44336; --warning-color: #ff9800; --info-color: #00bcd4;
        }
        body[data-theme="light"] {
            --bg-primary: #ffffff; --bg-secondary: #f5f5f5; --bg-tertiary: #eeeeee;
            --text-primary: #212121; --text-secondary: #757575; --text-tertiary: #bdbdbd;
            --accent: #77aa00; --accent-hover: #669900; --accent-yellow: #ffcc00;
            --text-on-accent: #ffffff; --border-color: #e0e0e0; --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #e53935; --warning-color: #fb8c00; --info-color: #00acc1;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); font-size: var(--font-size-base); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; transition: var(--transition); padding-top: 55px; }
        a { color: var(--accent); text-decoration: none; transition: var(--transition); }
        a:hover { color: var(--accent-hover); text-decoration: underline; }
        button { font-family: inherit; font-size: inherit; cursor: pointer; border: none; background: none; color: inherit; padding: 0; }
        ul, ol { list-style: none; }
		
		        /* --- Opcja 2: Logo z ikoną pinezki --- */
        .logo-option-2 {
            display: flex; /* Ustawia ikonę i tekst w jednej linii */
            align-items: center; /* Wyśrodkowuje ikonę i tekst pionowo */
        }

        .logo-option-2 .logo-icon {
            margin-right: 8px; /* Odstęp między ikoną a tekstem */
            font-size: 1.2em; /* Lekko powiększona ikona */
            color: var(--accent); /* Kolor ikony dopasowany do akcentu */
            line-height: 1; /* Zapobiega problemom z wysokością linii */
        }

        /* Zachowujemy oryginalne podświetlenie 'Trasa' */
        .logo-option-2 span {
           color: var(--accent);
        }
        /* --- Koniec Opcji 2 --- */

        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; transition: var(--transition); }
        .top-bar .logo { font-size: var(--font-size-large); font-weight: 600; color: var(--text-primary); }
        .top-bar .logo span { color: var(--accent); }
        .top-bar .controls { display: flex; align-items: center; gap: 15px; }
        .top-bar .theme-toggle { color: var(--text-secondary); font-size: 1.1em; transition: var(--transition); }
        .top-bar .theme-toggle:hover { color: var(--text-primary); }

        .container { max-width: 900px; margin: 20px auto; padding: 20px; }

        .feed-section { margin-bottom: 40px; }
        .feed-section h2 { font-size: calc(var(--font-size-large) + 2px); font-weight: 600; margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .feed-section h2 i.fa-bullhorn { color: var(--warning-color); }
        .feed-section h2 i.fa-newspaper { color: var(--info-color); }

        .feed-list { list-style: none; padding: 0; }
        li.feed-item { padding: 15px 20px; background: var(--bg-secondary); margin-bottom: 15px; border-radius: var(--border-radius); transition: var(--transition); border: 1px solid var(--border-color); }
        .feed-details {}
        .feed-title { font-size: var(--font-size-large); font-weight: 500; margin-bottom: 8px; }
        .feed-meta { font-size: var(--font-size-small); color: var(--text-secondary); margin-bottom: 10px; }
        .feed-meta strong { color: var(--text-primary); font-weight: 500; }
        .feed-description { margin-bottom: 12px; font-size: var(--font-size-base); }
        .feed-description p:first-child { margin-top: 0; }
        .feed-description p:last-child { margin-bottom: 0; }
        .feed-link { margin-top: 10px; }
        .feed-link a { font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
        .feed-link a i { font-size: 0.9em; }

        .status-message { padding: 20px; color: var(--text-secondary); text-align: center; background: var(--bg-secondary); border: 1px dashed var(--border-color); border-radius: var(--border-radius); margin-top: 10px; display: none; }
        .status-message.loading { display: block; border-style: solid; color: var(--text-primary); }
        .status-message.error { display: block; border-color: var(--danger-color); color: var(--danger-color); }
        .status-message.no-items { display: block; }
        .status-message i { margin-right: 8px; }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

         @media (max-width: 768px) {
            :root { --font-size-base: 13px; --font-size-small: 11px; --font-size-large: 15px; }
            .top-bar { height: 50px; padding: 0 10px; }
            .container { margin: 15px; padding: 15px; }
            .feed-section h2 { font-size: 18px; padding-bottom: 8px; margin-bottom: 15px; }
            li.feed-item { padding: 12px 15px;}
            .feed-title { font-size: var(--font-size-base); }
         }
    </style>
</head>
<body>
<body data-theme="dark">
    <div class="top-bar">
		<div class="logo logo-option-2">
			<i class="fas fa-map-marker-alt logo-icon"></i> Twoja<span> Trasa</span>
		</div>
        <div class="nav-links"> <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Mapa</a>
            <a href="menu.html" class="back-link"><i class="fas fa-bars"></i> Menu</a> </div>
    </div>

    <div class="container">
        <div class="feed-section">
            <h2><i class="fas fa-bullhorn"></i> Komunikaty ZTM</h2>
            <p id="statusKomunikaty" class="status-message"><i class="fas fa-spinner fa-spin"></i> Ładowanie...</p>
            <ul id="feedListKomunikaty" class="feed-list"></ul>
        </div>
        <div class="feed-section">
            <h2><i class="fas fa-newspaper"></i> Aktualności ZTM</h2>
            <p id="statusAktualnosci" class="status-message"><i class="fas fa-spinner fa-spin"></i> Ładowanie...</p>
            <ul id="feedListAktualnosci" class="feed-list"></ul>
        </div>
    </div>

    <script>
        // --- Funkcje pomocnicze ---
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const toggleIcon = document.getElementById('themeToggleBtn')?.querySelector('i');
            if (toggleIcon) {
                toggleIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`;
            }
        }
        function saveThemePreference(theme) {
            try { localStorage.setItem('theme', theme); } catch (e) { console.warn("Nie można zapisać preferencji motywu.", e); }
        }
        function formatDate(dateString) {
            if (!dateString) return 'Brak daty';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Nieprawidłowa data';
                return date.toLocaleString('pl-PL', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch (e) {
                console.error("Błąd formatowania daty:", dateString, e);
                return 'Błąd daty';
            }
        }

        /**
         * NOWA WERSJA: Pobiera dane z URL używając proxy CORS (api.allorigins.win)
         * @param {string} originalUrl - Oryginalny URL zasobu (np. kanału RSS ZTM).
         */
        async function fetchData(originalUrl) {
            const encodedUrl = encodeURIComponent(originalUrl);
            // Używamy publicznego proxy allorigins.win
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodedUrl}`;

            console.log(`Pobieranie przez proxy: ${proxyUrl} (oryginał: ${originalUrl})`);

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    let errorText = `Błąd HTTP proxy: ${response.status} ${response.statusText}`;
                     // Próba odczytania szczegółów błędu od allorigins
                     try {
                         const errorData = await response.json();
                         if (errorData && errorData.status && errorData.status.error) {
                             errorText = `Błąd od proxy allorigins: ${errorData.status.error}`;
                         } else if (errorData && errorData.error) { // Inny format błędu?
                            errorText = `Błąd od proxy allorigins: ${errorData.error}`;
                         }
                     } catch (e) { /* Ignoruj błąd parsowania JSON */ }
                    throw new Error(errorText);
                }
                return await response.text(); // Zwraca treść RSS
            } catch (error) {
                console.error(`Błąd podczas pobierania ${originalUrl} przez proxy ${proxyUrl}:`, error);
                if (error instanceof TypeError) { // Błąd sieciowy
                    throw new Error(`Problem z połączeniem do proxy (${proxyUrl}) lub błąd sieciowy.`);
                }
                // Przekaż błąd dalej (np. ten zwrócony przez proxy)
                throw error;
            }
        }

        /**
         * Parsuje XML RSS (bez zmian)
         * @param {string} xmlString
         */
        function parseRSS(xmlString) {
            const items = [];
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                const parserError = xmlDoc.querySelector("parsererror");
                if (parserError) {
                    console.error("Błąd parsowania XML:", parserError.textContent);
                    throw new Error("Nie udało się sparsować odpowiedzi RSS.");
                }
                const itemNodes = xmlDoc.querySelectorAll("item");
                itemNodes.forEach(node => {
                    items.push({
                        title: node.querySelector("title")?.textContent ?? '',
                        link: node.querySelector("link")?.textContent ?? '',
                        description: node.querySelector("description")?.textContent ?? '',
                        pubDate: node.querySelector("pubDate")?.textContent ?? ''
                    });
                });
            } catch (error) {
                console.error("Błąd podczas parsowania RSS:", error);
                 throw new Error("Wystąpił problem podczas przetwarzania danych RSS.");
            }
            return items;
        }

        /**
         * Ładuje, parsuje i wyświetla dane dla pojedynczego kanału RSS. (bez zmian)
         * @param {string} feedUrl - URL kanału RSS.
         * @param {string} listElementId - ID elementu UL listy.
         * @param {string} statusElementId - ID elementu P dla statusu.
         */
        async function loadAndDisplayFeed(feedUrl, listElementId, statusElementId) {
            const listEl = document.getElementById(listElementId);
            const statusEl = document.getElementById(statusElementId);

            function setSectionStatus(type, message = '') {
                if (!statusEl) return;
                statusEl.className = 'status-message';
                switch(type) {
                    case 'loading': statusEl.className = 'status-message loading'; statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Ładowanie...`; break;
                    case 'error': statusEl.className = 'status-message error'; statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message || 'Wystąpił błąd.'}`; break;
                    case 'no-items': statusEl.className = 'status-message no-items'; statusEl.innerHTML = `<i class="fas fa-info-circle"></i> Brak wpisów.`; break;
                    case 'hide': default: statusEl.style.display = 'none'; return;
                }
                statusEl.style.display = 'block';
            }

            if (!listEl || !statusEl) { console.error(`Nie znaleziono elementów DOM: #${listElementId} lub #${statusElementId}`); setSectionStatus('error', 'Błąd konfiguracji strony.'); return; }
            setSectionStatus('loading');
            listEl.innerHTML = '';

            try {
                const xmlString = await fetchData(feedUrl); // Używa nowej fetchData z proxy
                const items = parseRSS(xmlString);

                if (items.length === 0) { setSectionStatus('no-items'); return; }

                items.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                listEl.innerHTML = items.map(item => {
                    return `
                        <li class="feed-item">
                            <div class="feed-details">
                                <h3 class="feed-title">${item.title}</h3>
                                <div class="feed-meta"> Opublikowano: <strong>${formatDate(item.pubDate)}</strong> </div>
                                <div class="feed-description"> ${item.description} </div>
                                <div class="feed-link"> <a href="${item.link}" target="_blank" rel="noopener noreferrer"> Czytaj więcej <i class="fas fa-external-link-alt" aria-hidden="true"></i><span class="sr-only">(link otworzy się w nowej karcie)</span></a> </div>
                            </div>
                        </li>`;
                }).join('');
                setSectionStatus('hide');
            } catch (error) {
                console.error(`Błąd podczas przetwarzania kanału ${feedUrl}:`, error);
                setSectionStatus('error', error.message); // Wyświetl błąd zwrócony przez fetchData lub parseRSS
            }
        }

        // --- Główna logika po załadowaniu DOM (bez zmian) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ustawienie motywu
            let currentTheme = 'dark';
            try { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark' || savedTheme === 'light') { currentTheme = savedTheme; } } catch (e) { console.warn("Nie można odczytać preferencji motywu.", e); }
            applyTheme(currentTheme);
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (themeToggleBtn) { themeToggleBtn.addEventListener('click', () => { currentTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); saveThemePreference(currentTheme); }); }

            // Uruchom ładowanie dla każdej sekcji
            loadAndDisplayFeed('https://ztm.poznan.pl/feed/?post_type=komunikaty', 'feedListKomunikaty', 'statusKomunikaty');
            loadAndDisplayFeed('https://ztm.poznan.pl/feed/', 'feedListAktualnosci', 'statusAktualnosci');
        });
    </script>
</body>
</html>