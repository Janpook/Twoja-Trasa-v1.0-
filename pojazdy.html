<!DOCTYPE html>
<html lang="pl">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9G560TT5P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-N9G560TT5P');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Pojazdów - TwojaTrasa.online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="favicons.png" onerror="this.onerror=null; this.href='https://img.icons8.com/ios-filled/50/000000/bus-stop.png';">
    <style>
        :root { --bg-primary: #1a1a1a; --bg-secondary: #262626; --bg-tertiary: #333333; --text-primary: #e0e0e0; --text-secondary: #9e9e9e; --text-tertiary: #6b6b6b; --accent: #99cc00; --accent-hover: #88bb00; --accent-yellow: #ffdd00; --text-on-accent: #1a1a1a; --border-color: #404040; --shadow-color: rgba(0, 0, 0, 0.2); --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; --font-size-base: 14px; --font-size-small: 12px; --font-size-large: 16px; --border-radius: 4px; --transition: all 0.2s ease-in-out; --danger-color: #f44336; --warning-color: #ff9800; --ok-color: var(--accent); --info-color: #00bcd4; --discord-color: #5865F2; --discord-hover: #4a56d4; --buycoffee-color: #FF813F; --buycoffee-hover: #f06d2c;}
        body[data-theme="light"] { --bg-primary: #ffffff; --bg-secondary: #f5f5f5; --bg-tertiary: #eeeeee; --text-primary: #212121; --text-secondary: #757575; --text-tertiary: #bdbdbd; --accent: #77aa00; --accent-hover: #669900; --accent-yellow: #ffcc00; --text-on-accent: #ffffff; --border-color: #e0e0e0; --shadow-color: rgba(0, 0, 0, 0.1); --danger-color: #e53935; --warning-color: #fb8c00; --ok-color: var(--accent); --info-color: #00acc1; --discord-color: #5865F2; --discord-hover: #4a56d4; --buycoffee-color: #FF813F; --buycoffee-hover: #f06d2c;}
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); font-size: var(--font-size-base); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.7; transition: var(--transition); padding-top: 55px; }
        a { color: var(--accent); text-decoration: none; transition: var(--transition); font-weight: 500; }
        a:hover { color: var(--accent-hover); text-decoration: underline; }
        button { font-family: inherit; font-size: inherit; cursor: pointer; border: none; background: none; color: inherit; }
        ul { list-style: none; padding: 0; }
        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; transition: var(--transition); }
        .top-bar .logo { font-size: var(--font-size-large); font-weight: 600; color: var(--text-primary); }
        .top-bar .logo span { color: var(--accent); }
        .logo-option-2 { display: flex; align-items: center; }
        .logo-option-2 .logo-icon { margin-right: 8px; font-size: 1.2em; color: var(--accent); line-height: 1; }
        .logo-option-2 span { color: var(--accent); }
        .top-bar .nav-links { display: flex; }
        .top-bar .back-link { color: var(--accent); text-decoration: none; font-size: var(--font-size-base); transition: var(--transition); display: flex; align-items: center; gap: 5px; margin-left: 10px; }
        .top-bar .back-link:hover { color: var(--accent-hover); }
        .container { max-width: 950px; margin: 20px auto; padding: 30px; background-color: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .page-header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .page-header h1 { font-size: calc(var(--font-size-large) + 6px); font-weight: 600; color: var(--text-primary); margin-bottom: 10px; display: inline-flex; align-items: center; gap: 12px; border: none; padding: 0; }
        .page-header h1 i { color: var(--accent); }
        .page-header .subtitle { font-size: var(--font-size-large); color: var(--text-secondary); margin-top: 0; }
        .content-section { margin-bottom: 35px; }
        .content-section h2 { font-size: calc(var(--font-size-large) + 2px); font-weight: 500; margin-bottom: 15px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; transition: var(--transition); display: flex; align-items: center; gap: 10px; }
        .content-section h2 i { color: var(--accent); width: 1.1em; text-align: center; }
        p { margin-bottom: 1em; font-size: var(--font-size-base); }
        .footer-note { text-align: center; margin-top: 40px; font-size: var(--font-size-small); color: var(--text-tertiary); border-top: 1px solid var(--border-color); padding-top: 20px; }

        /* --- NOWE STYLE DLA LISTY POJAZDÓW --- */
        .vehicle-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 0;
            margin: 0;
        }
        .vehicle-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: var(--transition);
            cursor: pointer;
        }
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .vehicle-card img {
            max-width: 200px;
            max-height: 60px;
            object-fit: contain;
        }
        .vehicle-card .model-name {
            font-size: var(--font-size-large);
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .vehicle-card .tabor-numbers-title {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }
        .vehicle-card .tabor-numbers {
            font-size: var(--font-size-small);
            color: var(--text-tertiary);
            word-break: break-word;
            max-height: 80px;
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-primary);
        }
        .vehicle-card .tabor-numbers::-webkit-scrollbar {
            width: 6px;
        }
        .vehicle-card .tabor-numbers::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
        }
        .vehicle-card .tabor-numbers::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: var(--border-radius);
        }

        .vehicle-card .model-description {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-align: left;
            padding: 0 5px;
            max-height: 70px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-primary);
        }
        .vehicle-card .model-description::-webkit-scrollbar { width: 4px; }
        .vehicle-card .model-description::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: var(--border-radius); }
        .vehicle-card .model-description::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: var(--border-radius); }

        .vehicle-card .features-title {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
            margin-top: 10px;
            text-align: left;
            width: 100%;
            padding-left: 5px;
        }
        .vehicle-card .features-list { list-style: none; padding: 0; margin: 0 0 10px 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; width: 100%; font-size: var(--font-size-small); color: var(--text-tertiary); }
        .vehicle-card .features-list li { display: inline-flex; align-items: center; gap: 5px; padding: 3px 6px; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .vehicle-card .features-list li i { color: var(--accent); font-size: 0.9em; }
        .vehicle-card .tabor-numbers-title {
            text-align: left;
            width: 100%;
            padding-left: 5px;
        }
        .vehicle-card .tabor-numbers {
            text-align: left;
            padding-left: 5px;
        }

        /* Styl dla filtra i wyszukiwarki */
        .vehicle-filter-bar {
            margin-bottom: 18px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .vehicle-filter-bar label {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
        }
        .vehicle-filter-bar select {
            font-size: var(--font-size-base);
            padding: 3px 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .vehicle-search-bar {
            margin-bottom: 10px;
            width: 100%;
        }
        .vehicle-search-bar input {
            width: 100%;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        .vehicle-stats {
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .vehicle-export-bar {
            margin-bottom: 18px;
            text-align: right;
        }
        .vehicle-export-bar button {
            background: var(--accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: var(--border-radius);
            padding: 6px 16px;
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .vehicle-export-bar button:hover {
            background: var(--accent-hover);
        }
        /* Lightbox modal */
        .modal-lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
        }
        .modal-lightbox.active {
            display: flex;
        }
        .modal-lightbox img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 8px 32px #000a;
            background: #fff;
        }
        .modal-lightbox .close-btn {
            position: absolute;
            top: 30px;
            right: 40px;
            color: #fff;
            font-size: 2.5em;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            text-shadow: 0 2px 8px #000;
        }
        @media (max-width: 768px) {
            :root { --font-size-base: 13px; --font-size-small: 11px; --font-size-large: 15px; }
            .top-bar { height: 50px; padding: 0 10px; }
            .top-bar .logo { font-size: 18px; }
            .top-bar .back-link { font-size: var(--font-size-base); }
            body { padding-top: 50px; }
            .container { margin: 15px; padding: 20px; }
            .page-header h1 { font-size: 20px; }
            .page-header .subtitle { font-size: var(--font-size-base); }
            .content-section h2 { font-size: 18px; }
            p { font-size: var(--font-size-base); }
            .footer-note { font-size: 11px; }
            .vehicle-list-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="top-bar">
        <div class="logo logo-option-2">
            <i class="fas fa-map-marker-alt logo-icon"></i> Twoja<span>Trasa</span>
        </div>
        <div class="nav-links">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Mapa</a>
            <a href="menu.html" class="back-link"><i class="fas fa-bars"></i> Menu</a>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-bus"></i> Lista Pojazdów</h1>
            <p class="subtitle">Przegląd dostępnych modeli pojazdów w systemie.</p>
        </div>

        <div class="content-section">
            <h2><i class="fas fa-car-side"></i> Dostępne Modele</h2>
            <div class="vehicle-export-bar">
                <button id="exportCsvBtn"><i class="fas fa-file-csv"></i> Eksportuj do CSV</button>
            </div>
            <div class="vehicle-search-bar">
                <input type="text" id="vehicleSearch" placeholder="Szukaj modelu lub numeru taborowego...">
            </div>
            <div class="vehicle-filter-bar">
                <label for="vehicleTypeFilter">Filtruj:</label>
                <select id="vehicleTypeFilter">
                    <option value="all">Wszystkie</option>
                    <option value="tram">Tylko tramwaje</option>
                    <option value="bus">Tylko autobusy</option>
                </select>
                <select id="vehicleSort" style="margin-left:10px;">
                    <option value="name">Sortuj: Nazwa</option>
                    <option value="count">Sortuj: Liczba pojazdów</option>
                </select>
            </div>
            <div id="vehicleStats" class="vehicle-stats"></div>
            <div id="vehicleListContainer" class="vehicle-list-container">
                <p>Ładowanie listy pojazdów...</p>
            </div>
        </div>

        <div class="footer-note">
              TwojaTrasa.online &copy; <span id="currentYear">2024</span>. Tworzone z pasją. | <a href="polityka-prywatnosci.html">Polityka Prywatności</a> | <a href="cookies.html">Ustawienia Cookies</a>
        </div>
    </div>

    <!-- Lightbox modal for images -->
    <div class="modal-lightbox" id="vehicleLightbox">
        <span class="close-btn" id="lightboxCloseBtn">&times;</span>
        <img src="" alt="Pojazd" id="lightboxImg">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }
        document.addEventListener('DOMContentLoaded', () => {
            let currentTheme = 'dark'; try { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark' || savedTheme === 'light') { currentTheme = savedTheme; } } catch (e) {} applyTheme(currentTheme);
            const yearSpan = document.getElementById('currentYear'); if(yearSpan) { const y = new Date().getFullYear(); yearSpan.textContent = y > 2024 ? `2024-${y}` : y; }

            const vehicleListContainer = document.getElementById('vehicleListContainer');
            const vehicleDictionary = {};
            let lastGroupedModels = null;
            let lastFilteredModels = null;

            function getVehicleType(modelName) {
                const lower = modelName.toLowerCase();
                if (
                    lower.includes('tram') ||
                    lower.includes('konstal') ||
                    lower.includes('moderus') ||
                    lower.includes('tatra') ||
                    lower.includes('siemens') ||
                    lower.includes('düwag') ||
                    lower.includes('combino') ||
                    lower.includes('tramino')
                ) return 'tram';
                if (
                    lower.includes('bus') ||
                    lower.includes('solaris') ||
                    lower.includes('man') ||
                    lower.includes('mercedes') ||
                    lower.includes('kapena') ||
                    lower.includes('urbino') ||
                    lower.includes('mercus')
                ) return 'bus';
                return 'other';
            }

            function generateModelDescription(modelName) {
                // Usunięto opisy pojazdów – zwracaj pusty string
                return "";
            }

            function updateVehicleStats(groupedModels) {
                let tram = 0, bus = 0, other = 0;
                for (const model in groupedModels) {
                    const type = getVehicleType(model);
                    if (type === 'tram') tram++;
                    else if (type === 'bus') bus++;
                    else other++;
                }
                document.getElementById('vehicleStats').textContent =
                    `Wszystkich modeli: ${Object.keys(groupedModels).length} | Tramwaje: ${tram} | Autobusy: ${bus}`;
            }

            function renderVehicleCards(groupedModels, filterType = 'all', sortType = 'name') {
                vehicleListContainer.innerHTML = '';

                if (Object.keys(groupedModels).length === 0) {
                    vehicleListContainer.innerHTML = '<p>Nie znaleziono danych o pojazdach.</p>';
                    updateVehicleStats(groupedModels);
                    return;
                }

                let sortedModelNames = Object.keys(groupedModels);
                if (sortType === 'count') {
                    sortedModelNames.sort((a, b) => groupedModels[b].tabor_numbers.length - groupedModels[a].tabor_numbers.length);
                } else {
                    sortedModelNames.sort();
                }

                let anyVisible = false;

                for (const modelName of sortedModelNames) {
                    const model = groupedModels[modelName];
                    if (model.features.description.includes("Nieznany model")) continue;
                    const type = getVehicleType(modelName);
                    if (filterType !== 'all' && type !== filterType) continue;
                    anyVisible = true;

                    model.tabor_numbers.sort((a, b) => parseInt(a) - parseInt(b));

                    const card = document.createElement('div');
                    card.className = 'vehicle-card';

                    let featuresHTML = '<ul class="features-list">';
                    if (model.features.ramp) featuresHTML += '<li><i class="fas fa-wheelchair" title="Rampa dla wózków"></i> Rampa</li>';
                    featuresHTML += `<li><i class="fas fa-shoe-prints" title="Typ podłogi"></i> ${model.features.floorType}</li>`;
                    if (model.features.air_conditioner) featuresHTML += '<li><i class="fas fa-snowflake" title="Klimatyzacja"></i> Klimatyzacja</li>';
                    if (model.features.place_for_transp_bicycles) featuresHTML += '<li><i class="fas fa-bicycle" title="Miejsce na rowery"></i> Przewóz rowerów</li>';
                    if (model.features.voice_announcement_sys) featuresHTML += '<li><i class="fas fa-volume-up" title="Zapowiedzi głosowe"></i> Zapowiedzi głosowe</li>';
                    if (model.features.ticket_machine) featuresHTML += '<li><i class="fas fa-ticket-alt" title="Biletomat"></i> Biletomat</li>';
                    if (model.features.ticket_sales_by_the_driver) featuresHTML += '<li><i class="fas fa-cash-register" title="Bilet u kierowcy"></i> Bilet u kierowcy</li>';
                    if (model.features.usb_charger) featuresHTML += '<li><i class="fab fa-usb" title="Ładowarki USB"></i> Ładowarki USB</li>';
                    featuresHTML += '</ul>';

                    card.innerHTML = `
                        <img src="${model.icon_url}" alt="${modelName}" data-img="${model.icon_url}" class="vehicle-img" onerror="this.style.display='none'; this.nextElementSibling.insertAdjacentHTML('beforebegin', '<p style=\'font-size:var(--font-size-small); color:var(--text-tertiary);\'>Brak obrazka</p>');">
                        <div class="model-name">${modelName} <span style="color:var(--accent);font-size:12px;">(${model.tabor_numbers.length})</span></div>
                        <div class="model-description"></div>
                        <div class="features-title">Udogodnienia:</div>
                        ${featuresHTML}
                        <div class="tabor-numbers-title">Numery taborowe (${model.tabor_numbers.length}):</div>
                        <div class="tabor-numbers">${model.tabor_numbers.join(', ')}</div>
                    `;
                    vehicleListContainer.appendChild(card);
                }
                if (!anyVisible) {
                    vehicleListContainer.innerHTML = '<p>Brak pojazdów dla wybranego filtra.</p>';
                }
                updateVehicleStats(groupedModels);

                // Lightbox obsługa
                document.querySelectorAll('.vehicle-card img.vehicle-img').forEach(img => {
                    img.addEventListener('click', function(e) {
                        const src = this.getAttribute('data-img');
                        if (!src) return;
                        const lightbox = document.getElementById('vehicleLightbox');
                        const lightboxImg = document.getElementById('lightboxImg');
                        lightboxImg.src = src;
                        lightbox.style.display = 'flex';
                        lightbox.classList.add('active');
                    });
                });
            }

            // Wyszukiwanie modeli i numerów taborowych
            function filterModelsBySearch(query, groupedModels) {
                if (!query) return groupedModels;
                const filtered = {};
                for (const model in groupedModels) {
                    if (
                        model.toLowerCase().includes(query) ||
                        groupedModels[model].tabor_numbers.some(num => num.includes(query))
                    ) {
                        filtered[model] = groupedModels[model];
                    }
                }
                return filtered;
            }

            // Eksport do CSV
            function exportToCsv(models) {
                let csv = 'Model;Numery taborowe;Typ podłogi;Rampa;Klimatyzacja;Biletomat;Bilet u kierowcy;USB;Rower;Zapowiedzi\n';
                for (const model in models) {
                    const m = models[model];
                    csv += `"${model}";"${m.tabor_numbers.join(', ')}";"${m.features.floorType}";"${m.features.ramp ? 'TAK' : ''}";"${m.features.air_conditioner ? 'TAK' : ''}";"${m.features.ticket_machine ? 'TAK' : ''}";"${m.features.ticket_sales_by_the_driver ? 'TAK' : ''}";"${m.features.usb_charger ? 'TAK' : ''}";"${m.features.place_for_transp_bicycles ? 'TAK' : ''}";"${m.features.voice_announcement_sys ? 'TAK' : ''}"\n`;
                }
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pojazdy.csv';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }

            Promise.all([
                fetch('models.txt').then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for models.txt`);
                    return response.text();
                }),
                fetch('vehicle_dictionary.txt').then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for vehicle_dictionary.txt`);
                    return response.text();
                })
            ])
            .then(([modelsDataText, dictDataText]) => {
                Papa.parse(dictDataText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(dictResults) {
                        if (dictResults.errors.length > 0) {
                            console.warn("Błędy parsowania vehicle_dictionary.txt:", dictResults.errors);
                        }
                        dictResults.data.forEach(entry => {
                            if (entry.vehicle) {
                                vehicleDictionary[entry.vehicle.trim()] = entry;
                            }
                        });

                        Papa.parse(modelsDataText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(modelsResults) {
                                if (modelsResults.errors.length > 0) {
                                    console.warn("Błędy parsowania models.txt:", modelsResults.errors);
                                }
                                const modelsData = modelsResults.data;
                                const groupedModels = {};

                                modelsData.forEach(vehicle => {
                                    if (vehicle.model_name && vehicle.tabor_number) {
                                        const modelNameClean = vehicle.model_name.trim();
                                        const taborNumberClean = vehicle.tabor_number.trim();
                                        if (!groupedModels[modelNameClean]) {
                                            groupedModels[modelNameClean] = {
                                                icon_url: vehicle.icon_url,
                                                tabor_numbers: [],
                                                features: {
                                                    ramp: false, floorType: 'Nieznany', air_conditioner: false,
                                                    place_for_transp_bicycles: false, voice_announcement_sys: false,
                                                    ticket_machine: false, ticket_sales_by_the_driver: false, usb_charger: false,
                                                    description: generateModelDescription(modelNameClean)
                                                }
                                            };
                                        }
                                        groupedModels[modelNameClean].tabor_numbers.push(taborNumberClean);
                                    }
                                });

                                for (const modelName in groupedModels) {
                                    const model = groupedModels[modelName];
                                    const floorTypesRaw = [];

                                    model.tabor_numbers.forEach(taborNumber => {
                                        const dictEntry = vehicleDictionary[taborNumber];
                                        if (dictEntry) {
                                            if (dictEntry.ramp === '1') model.features.ramp = true;
                                            if (dictEntry.air_conditioner === '1') model.features.air_conditioner = true;
                                            if (dictEntry.place_for_transp_bicycles === '1') model.features.place_for_transp_bicycles = true;
                                            if (dictEntry.voice_announcement_sys === '1') model.features.voice_announcement_sys = true;
                                            if (dictEntry.ticket_machine === '1') model.features.ticket_machine = true;
                                            if (dictEntry.ticket_sales_by_the_driver === '1') model.features.ticket_sales_by_the_driver = true;
                                            if (dictEntry.usb_charger === '1') model.features.usb_charger = true;
                                            if (dictEntry.hf_lf_le) floorTypesRaw.push(dictEntry.hf_lf_le);
                                        }
                                    });

                                    if (floorTypesRaw.length > 0) {
                                        const hasLowFloor = floorTypesRaw.includes('1');
                                        const hasLowEntry = floorTypesRaw.includes('2');
                                        const hasHighFloor = floorTypesRaw.includes('0');
                                        const uniqueFloorTypesCount = new Set(floorTypesRaw).size;

                                        if (hasLowFloor) model.features.floorType = 'Niskopodłogowy';
                                        else if (hasLowEntry) model.features.floorType = 'Niskowejściowy';
                                        else if (hasHighFloor) model.features.floorType = 'Wysokopodłogowy';

                                        if (uniqueFloorTypesCount > 1 && model.features.floorType !== 'Nieznany') {
                                            model.features.floorType += ' (mieszane)';
                                        }
                                    }
                                }
                                lastGroupedModels = groupedModels;
                                lastFilteredModels = groupedModels;
                                renderVehicleCards(groupedModels, document.getElementById('vehicleTypeFilter').value, document.getElementById('vehicleSort').value);
                            },
                            error: function(error) {
                                console.error("Błąd parsowania models.txt:", error);
                                vehicleListContainer.innerHTML = '<p>Wystąpił błąd podczas ładowania danych o modelach pojazdów.</p>';
                            }
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Błąd podczas pobierania plików:', error);
                vehicleListContainer.innerHTML = '<p>Nie udało się pobrać niezbędnych plików z danymi.</p>';
            });

            // Obsługa filtra typu pojazdu
            document.getElementById('vehicleTypeFilter').addEventListener('change', function() {
                if (lastGroupedModels) {
                    const searchQuery = document.getElementById('vehicleSearch').value.trim().toLowerCase();
                    const filtered = filterModelsBySearch(searchQuery, lastGroupedModels);
                    lastFilteredModels = filtered;
                    renderVehicleCards(filtered, this.value, document.getElementById('vehicleSort').value);
                }
            });

            // Obsługa sortowania
            document.getElementById('vehicleSort').addEventListener('change', function() {
                if (lastFilteredModels) {
                    renderVehicleCards(lastFilteredModels, document.getElementById('vehicleTypeFilter').value, this.value);
                }
            });

            // Obsługa wyszukiwarki
            document.getElementById('vehicleSearch').addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (lastGroupedModels) {
                    const filtered = filterModelsBySearch(query, lastGroupedModels);
                    lastFilteredModels = filtered;
                    renderVehicleCards(filtered, document.getElementById('vehicleTypeFilter').value, document.getElementById('vehicleSort').value);
                }
            });

            // Obsługa eksportu do CSV
            document.getElementById('exportCsvBtn').addEventListener('click', function() {
                if (lastFilteredModels) {
                    exportToCsv(lastFilteredModels);
                }
            });

            // Lightbox zamykanie
            const lightbox = document.getElementById('vehicleLightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            document.getElementById('lightboxCloseBtn').addEventListener('click', function() {
                lightbox.classList.remove('active');
                setTimeout(() => { lightbox.style.display = 'none'; lightboxImg.src = ''; }, 200);
            });
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    lightbox.classList.remove('active');
                    setTimeout(() => { lightbox.style.display = 'none'; lightboxImg.src = ''; }, 200);
                }
            });
        });
    </script>
</body>
</html>