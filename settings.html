<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ustawienia - TwojaTrasa.online</title> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="favicons.png" onerror="this.onerror=null; this.href='https://img.icons8.com/ios-filled/50/000000/bus-stop.png';">
    <style>
        /* --- CSS (Minimalistyczny / Dark / MPK) --- */
        /* WAŻNE: Te style powinny być identyczne jak w index.html lub pochodzić ze wspólnego pliku CSS */
        :root { --bg-primary: #1a1a1a; --bg-secondary: #262626; --bg-tertiary: #333333; --text-primary: #e0e0e0; --text-secondary: #9e9e9e; --text-tertiary: #6b6b6b; --accent: #99cc00; --accent-hover: #88bb00; --accent-yellow: #ffdd00; --text-on-accent: #1a1a1a; --border-color: #404040; --shadow-color: rgba(0, 0, 0, 0.2); --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; --font-size-base: 14px; --font-size-small: 12px; --font-size-large: 16px; --border-radius: 4px; --transition: all 0.2s ease-in-out; --danger-color: #f44336; --warning-color: #ff9800; --ok-color: var(--accent); --info-color: #00bcd4; }
        body[data-theme="light"] { --bg-primary: #ffffff; --bg-secondary: #f5f5f5; --bg-tertiary: #eeeeee; --text-primary: #212121; --text-secondary: #757575; --text-tertiary: #bdbdbd; --accent: #77aa00; --accent-hover: #669900; --accent-yellow: #ffcc00; --text-on-accent: #ffffff; --border-color: #e0e0e0; --shadow-color: rgba(0, 0, 0, 0.1); --danger-color: #e53935; --warning-color: #fb8c00; --ok-color: var(--accent); --info-color: #00acc1; }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); font-size: var(--font-size-base); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; transition: var(--transition); padding-top: 55px; /* Miejsce na top-bar */ }
        a { color: var(--accent); text-decoration: none; transition: var(--transition); }
        a:hover { color: var(--accent-hover); text-decoration: underline; }
        button { font-family: inherit; font-size: inherit; cursor: pointer; border: none; background: none; color: inherit; }
        ul, ol { list-style: none; }
        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; transition: var(--transition); }
        .top-bar .logo { font-size: var(--font-size-large); font-weight: 600; color: var(--text-primary); }
        .top-bar .logo span { color: var(--accent); }
        .top-bar .back-link { color: var(--accent); text-decoration: none; font-size: var(--font-size-base); transition: var(--transition); display: flex; align-items: center; gap: 5px; }
        .top-bar .back-link:hover { color: var(--accent-hover); }

        /* --- Opcja 2: Logo z ikoną pinezki --- */
        .logo-option-2 {
            display: flex; /* Ustawia ikonę i tekst w jednej linii */
            align-items: center; /* Wyśrodkowuje ikonę i tekst pionowo */
        }
        .logo-option-2 .logo-icon {
            margin-right: 8px; /* Odstęp między ikoną a tekstem */
            font-size: 1.2em; /* Lekko powiększona ikona */
            color: var(--accent); /* Kolor ikony dopasowany do akcentu */
            line-height: 1; /* Zapobiega problemom z wysokością linii */
        }
        .logo-option-2 span {
           color: var(--accent);
        }
        /* --- Koniec Opcji 2 --- */

        /* --- Główny kontener dla podstron --- */
        .container { max-width: 700px; margin: 20px auto; padding: 20px; }

        /* --- Style specyficzne dla settings.html --- */
        .container h1 { font-size: calc(var(--font-size-large) + 4px); font-weight: 600; margin-bottom: 30px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .container h1 i { color: var(--accent); }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px; /* Mniejszy padding pionowy */
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            background-color: var(--bg-secondary); /* Tło dla wiersza */
            margin-bottom: 10px; /* Odstęp między wierszami */
            border-radius: var(--border-radius);
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-item label { font-size: var(--font-size-base); font-weight: 500; flex-grow: 1; margin-right: 15px; }

        /* Przycisk stylizowany jak na mapie */
        .setting-item button {
            background-color: var(--accent);
            color: var(--text-on-accent);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: var(--font-size-small);
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px; /* Odstęp ikona-tekst */
            min-width: 140px; /* Ustawiona szerokość */
            justify-content: center;
            text-align: center;
            border: none; /* Upewnij się, że nie ma domyślnej ramki */
        }
        .setting-item button:hover { background-color: var(--accent-hover); }
        .setting-item button i { font-size: 1em; }

        .back-link-footer { /* Link powrotu na dole */
            display: block;
            text-align: center;
            margin-top: 30px;
            color: var(--accent);
            font-weight: 500;
        }
        .back-link-footer:hover { color: var(--accent-hover); }

        /* Powiadomienia */
        .notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: auto; max-width: 90%; z-index: 1500; display: flex; flex-direction: column-reverse; align-items: center; gap: 10px; }
        .notification { display: flex; align-items: center; padding: 10px 15px; border-radius: var(--border-radius); box-shadow: 0 3px 8px var(--shadow-color); font-size: var(--font-size-base); color: #fff; width: auto; max-width: 400px; opacity: 1; transition: opacity 0.3s ease, transform 0.3s ease; background-color: var(--bg-tertiary); }
        .notification.info { background-color: var(--accent); color: var(--text-on-accent); }
        .notification.error { background-color: var(--danger-color); color: #fff; } /* Dodano styl dla błędu */
        .notification .icon { margin-right: 10px; }
        .notification .close-btn { margin-left: 15px; background: none; border: none; font-size: 16px; cursor: pointer; color: inherit; opacity: 0.7; padding: 0; line-height: 1; }
        .notification .close-btn:hover { opacity: 1; }

        /* Media Queries */
        @media (max-width: 768px) {
             :root { --font-size-base: 13px; --font-size-small: 11px; --font-size-large: 15px; }
             .top-bar { height: 50px; padding: 0 10px; }
             .top-bar .logo { font-size: 18px; }
             .top-bar .back-link { font-size: var(--font-size-base); }
             body { padding-top: 50px; }
             .container { margin: 15px; padding: 15px; }
             .container h1 { font-size: 18px; padding-bottom: 10px; margin-bottom: 20px; }
             .setting-item { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px; }
             .setting-item label { margin-bottom: 5px; margin-right: 0; /* Reset marginesu */ }
             .setting-item button { width: 100%; } /* Przycisk na całą szerokość */
             .notification { max-width: 95%; font-size: 13px; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="top-bar">
        <div class="logo logo-option-2">
            <i class="fas fa-map-marker-alt logo-icon"></i> Twoja<span> Trasa</span>
        </div>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Mapa</a>
    </div>

    <div class="container">
        <h1><i class="fas fa-cog"></i> Ustawienia</h1>

        <div class="setting-item">
            <label for="toggleStopsBtn">Ikony przystanków na mapie</label>
            <button id="toggleStopsBtn">
                <i class="fas fa-spinner fa-spin"></i> <span>Ładowanie...</span>
            </button>
        </div>

        <div class="setting-item">
            <label for="toggleClusteringBtn">Grupowanie pojazdów (widok z daleka)</label>
            <button id="toggleClusteringBtn">
                <i class="fas fa-spinner fa-spin"></i> <span>Ładowanie...</span>
            </button>
        </div>

        <div class="setting-item">
            <label for="toggleMarkerStyleBtn">Styl ikony pojazdu na mapie</label>
            <button id="toggleMarkerStyleBtn">
                <i class="fas fa-spinner fa-spin"></i> <span>Ładowanie...</span>
            </button>
        </div>
        <div class="setting-item">
            <label for="toggleThemeBtn">Motyw wyglądu</label>
            <button id="toggleThemeBtn">
                <i class="fas fa-spinner fa-spin"></i> <span>Ładowanie...</span>
            </button>
        </div>

        <a href="index.html" class="back-link-footer"><i class="fas fa-arrow-left"></i> Wróć do mapy</a>
    </div>

    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // --- Klucze LocalStorage ---
        const themeKey = 'theme';
        const stopsKey = 'stopsVisible';
        const clusteringKey = 'farZoomClusteringEnabled';
        const markerStyleKey = 'vehicleMarkerStyle'; // <<< NOWY KLUCZ

        // --- Zmienne stanu ---
        let currentTheme = 'dark';
        let areStopsVisible = true;
        let isFarZoomClusteringEnabled = true;
        let currentMarkerStyle = 'icon'; // <<< NOWA ZMIENNA ('icon' lub 'dot')

        // --- Referencje do przycisków ---
        const toggleStopsButton = document.getElementById('toggleStopsBtn');
        const toggleThemeButton = document.getElementById('toggleThemeBtn');
        const toggleClusteringButton = document.getElementById('toggleClusteringBtn');
        const toggleMarkerStyleButton = document.getElementById('toggleMarkerStyleBtn'); // <<< NOWY PRZYCISK

        // --- Funkcje pomocnicze ---
        function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }

        function updateStopToggleUI() {
            if (!toggleStopsButton) return;
            const icon = toggleStopsButton.querySelector('i');
            const textSpan = toggleStopsButton.querySelector('span');
            if (!icon || !textSpan) return; // Sprawdź czy elementy istnieją
            icon.className = areStopsVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
            textSpan.textContent = areStopsVisible ? 'Widoczne' : 'Ukryte';
        }

        function updateThemeToggleUI() {
            if (!toggleThemeButton) return;
            const icon = toggleThemeButton.querySelector('i');
            const textSpan = toggleThemeButton.querySelector('span');
             if (!icon || !textSpan) return;
            icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            textSpan.textContent = currentTheme === 'light' ? 'Zmień na Ciemny' : 'Zmień na Jasny';
        }

        function updateClusteringToggleUI() {
            if (!toggleClusteringButton) return;
            const icon = toggleClusteringButton.querySelector('i');
            const textSpan = toggleClusteringButton.querySelector('span');
             if (!icon || !textSpan) return;
            icon.className = isFarZoomClusteringEnabled ? 'fas fa-object-group' : 'fas fa-th';
            textSpan.textContent = isFarZoomClusteringEnabled ? 'Włączone' : 'Wyłączone';
        }

        // <<< --- NOWA FUNKCJA AKTUALIZACJI UI DLA STYLU MARKERA --- >>>
        function updateMarkerStyleToggleUI() {
            if (!toggleMarkerStyleButton) return;
            const icon = toggleMarkerStyleButton.querySelector('i');
            const textSpan = toggleMarkerStyleButton.querySelector('span');
             if (!icon || !textSpan) return;
            icon.className = currentMarkerStyle === 'icon' ? 'fas fa-bus' : 'fas fa-circle'; // Używamy fa-bus i fa-circle
            textSpan.textContent = currentMarkerStyle === 'icon' ? 'Ikona pojazdu' : 'Kropka z linią';
        }
        // <<< ------------------------------------------------------ >>>

        function showNotification(type, message, duration = 3000) {
             const cont = document.getElementById('notificationContainer');
             if (!cont) return;
             const div = document.createElement('div');
             div.className = `notification ${type}`;
             let iconClass = '';
             switch(type){
                case 'info': iconClass='info-circle'; break;
                case 'error': iconClass='times-circle'; break;
                default: iconClass='info-circle'; break;
             }
             div.innerHTML = `<i class="fas fa-${iconClass} icon"></i><span>${message}</span><button class="close-btn" onclick="this.parentElement.remove()">✕</button>`;
             cont.prepend(div); // Dodaj na górze kontenera
             if(duration>0) setTimeout(()=>{
                 if(div.parentElement){ // Sprawdź czy element nadal istnieje
                      div.style.opacity='0';
                      div.style.transform='translateY(10px)'; // Efekt znikania w górę
                      setTimeout(()=>div.remove(),500); // Usuń z DOM po animacji
                 }
             }, duration);
        }

        // --- Główna logika po załadowaniu DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Wczytaj motyw
                const savedTheme = localStorage.getItem(themeKey);
                if (savedTheme === 'light' || savedTheme === 'dark') { currentTheme = savedTheme; }
                else { currentTheme = 'dark'; } // Domyślny jeśli brak/nieprawidłowy
                applyTheme(currentTheme);
                updateThemeToggleUI();

                // Wczytaj widoczność przystanków
                const savedStops = localStorage.getItem(stopsKey);
                if (savedStops !== null) { areStopsVisible = (savedStops === 'true'); }
                else { areStopsVisible = true; } // Domyślnie widoczne
                updateStopToggleUI();

                // Wczytaj ustawienie grupowania pojazdów
                const savedClustering = localStorage.getItem(clusteringKey);
                if (savedClustering !== null) { isFarZoomClusteringEnabled = (savedClustering === 'true'); }
                else { isFarZoomClusteringEnabled = true; } // Domyślnie włączone
                updateClusteringToggleUI();

                // <<< --- NOWE: Wczytaj ustawienie stylu markera --- >>>
                const savedMarkerStyle = localStorage.getItem(markerStyleKey);
                if (savedMarkerStyle === 'icon' || savedMarkerStyle === 'dot') {
                     currentMarkerStyle = savedMarkerStyle;
                } else {
                     currentMarkerStyle = 'icon'; // Domyślny
                }
                updateMarkerStyleToggleUI();
                // <<< --------------------------------------------- >>>

            } catch (e) {
                console.error("Błąd wczytywania ustawień z LocalStorage:", e);
                // Informowanie użytkownika o błędzie wczytywania, jeśli przyciski istnieją
                if(toggleStopsButton) toggleStopsButton.querySelector('span').textContent = 'Błąd LS';
                if(toggleThemeButton) toggleThemeButton.querySelector('span').textContent = 'Błąd LS';
                if(toggleClusteringButton) toggleClusteringButton.querySelector('span').textContent = 'Błąd LS';
                if(toggleMarkerStyleButton) toggleMarkerStyleButton.querySelector('span').textContent = 'Błąd LS'; // NOWE
                showNotification('error', 'Nie udało się wczytać zapisanych ustawień.');
            }

            // Event Listener dla przycisku przystanków
            if (toggleStopsButton) {
                toggleStopsButton.addEventListener('click', () => {
                    try {
                         areStopsVisible = !areStopsVisible;
                         localStorage.setItem(stopsKey, areStopsVisible.toString());
                         updateStopToggleUI();
                         showNotification('info', `Widoczność przystanków: ${areStopsVisible ? 'Włączona' : 'Wyłączona'}. Zmiana widoczna po odświeżeniu mapy.`);
                    } catch (e) {
                         console.error("Błąd zapisu widoczności przystanków:", e);
                         showNotification('error', 'Błąd zapisu ustawienia przystanków.');
                         // Przywróć poprzedni stan, jeśli zapis się nie udał
                         areStopsVisible = !areStopsVisible;
                         updateStopToggleUI();
                    }
                });
            }

            // Event Listener dla przycisku motywu
            if (toggleThemeButton) {
                toggleThemeButton.addEventListener('click', () => {
                     try {
                         currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
                         localStorage.setItem(themeKey, currentTheme);
                         applyTheme(currentTheme);
                         updateThemeToggleUI();
                         showNotification('info', `Zmieniono motyw na: ${currentTheme === 'light' ? 'Jasny' : 'Ciemny'}.`);
                     } catch (e) {
                          console.error("Błąd zapisu motywu:", e);
                          showNotification('error', 'Błąd zapisu ustawienia motywu.');
                          // Przywróć poprzedni stan
                          currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
                          applyTheme(currentTheme);
                          updateThemeToggleUI();
                     }
                });
            }

            // Event Listener dla przycisku grupowania
            if (toggleClusteringButton) {
                toggleClusteringButton.addEventListener('click', () => {
                    try {
                         isFarZoomClusteringEnabled = !isFarZoomClusteringEnabled;
                         localStorage.setItem(clusteringKey, isFarZoomClusteringEnabled.toString());
                         updateClusteringToggleUI();
                         showNotification('info', `Grupowanie pojazdów z daleka: ${isFarZoomClusteringEnabled ? 'Włączone' : 'Wyłączone'}. Zmiana widoczna po odświeżeniu mapy.`);
                    } catch (e) {
                         console.error("Błąd zapisu ustawienia grupowania:", e);
                         showNotification('error', 'Błąd zapisu ustawienia grupowania.');
                         // Przywróć poprzedni stan
                         isFarZoomClusteringEnabled = !isFarZoomClusteringEnabled;
                         updateClusteringToggleUI();
                    }
                });
            }

            // <<< --- NOWE: Event Listener dla przycisku stylu markera --- >>>
            if (toggleMarkerStyleButton) {
                toggleMarkerStyleButton.addEventListener('click', () => {
                    try {
                        currentMarkerStyle = (currentMarkerStyle === 'icon') ? 'dot' : 'icon';
                        localStorage.setItem(markerStyleKey, currentMarkerStyle);
                        updateMarkerStyleToggleUI();
                        showNotification('info', `Styl ikon pojazdów: ${currentMarkerStyle === 'icon' ? 'Ikona pojazdu' : 'Kropka z linią'}. Zmiana widoczna po odświeżeniu mapy.`);
                    } catch (e) {
                         console.error("Błąd zapisu stylu markera do LocalStorage:", e);
                         showNotification('error', 'Błąd zapisu ustawienia stylu markera.');
                         // Przywróć poprzedni stan
                         currentMarkerStyle = (currentMarkerStyle === 'icon') ? 'dot' : 'icon';
                         updateMarkerStyleToggleUI();
                    }
                });
            }
            // <<< -------------------------------------------------------- >>>
        });
    </script>
</body>
</html>